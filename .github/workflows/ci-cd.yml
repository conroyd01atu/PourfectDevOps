name: PourfectApp CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  DOTNET_VERSION: '8.0.x'

jobs:
  build-and-test:
    runs-on: windows-latest
    name: Build and Test PourfectApp
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
    
    - name: Setup Java JDK (required for Android)
      uses: actions/setup-java@v4
      with:
        distribution: 'microsoft'
        java-version: '11'
    
    - name: Install MAUI Workload
      run: dotnet workload install maui --ignore-failed-sources
    
    - name: Restore NuGet packages
      run: dotnet restore
    
    - name: Build solution
      run: dotnet build --no-restore --configuration Release
    
    - name: Run tests (if any exist)
      run: |
        if (Test-Path "**/*Tests.csproj") {
          dotnet test --no-build --configuration Release --verbosity normal
        } else {
          Write-Host "No test projects found - skipping tests"
        }
      shell: pwsh
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts
        path: |
          **/bin/Release/**
          !**/bin/Release/**/ref/**
          !**/bin/Release/**/runtimes/**

  code-quality:
    runs-on: windows-latest
    name: Code Quality Check
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Required for SonarCloud
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
    
    - name: Setup Java JDK (required for SonarCloud)
      uses: actions/setup-java@v4
      with:
        distribution: 'microsoft'
        java-version: '17'
    
    - name: Install MAUI Workload
      run: dotnet workload install maui --ignore-failed-sources
    
    - name: Restore dependencies
      run: dotnet restore
    
    - name: SonarCloud Scan
      uses: SonarSource/sonarcloud-github-action@master
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  android-build:
    needs: [build-and-test]
    runs-on: windows-latest
    if: github.ref == 'refs/heads/main'
    name: Build Android APK
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
    
    - name: Setup Java JDK
      uses: actions/setup-java@v4
      with:
        distribution: 'microsoft'
        java-version: '11'
    
    - name: Install MAUI Workload
      run: dotnet workload install maui --ignore-failed-sources
    
    - name: Restore dependencies
      run: dotnet restore
    
    - name: Build Android APK
      run: dotnet publish -f net8.0-android -c Release
    
    - name: Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: android-apk
        path: "**/publish/*.apk"